# 실시간 좌석 예약 서비스 기획안

# 1. 요구사항 분석

## 1.1. 개요

이용자가 네이버 예약 시스템의 회차형 업종 중 좌석사용 상품을 예약할 때 좌석 선택 단계에서 복수의 이용자가 동시에 같은 좌석을 선택할 수 있는 문제에 대한 해결책 제시

## 1.2 문제 의식

네이버 예약 플랫폼은 연극, 뮤지컬, 콘서트 등의 공연을 예매하는 서비스를 제공합니다. 네이버 예약의 도메인 상으론 공연은 회차형 업종으로 분류하며, 회차형 업종은 좌석을 지정하지 않고 예약할 수 있는 일반 상품과 예약 단계에서 좌석을 지정할 수 있는 좌석 사용 상품으로 나뉘어집니다.

좌석 사용 상품의 예약 절차는 다음과 같습니다.

```bash
공연 선택 -> 일정 선택 -> 좌석 선택 -> 예매자 정보 입력 및 이용자 약관 동의 -> 결제
```

이 중 `좌석 선택` 단계는 PC에서 접속했을 때 다음과 같은 화면 구성을 보입니다.

![좌석 선택](https://media.oss.navercorp.com/user/21309/files/23b15d80-24e1-11eb-959c-aecd5beebd8e)

본 단계에서 예약 가능한 좌석을 클릭하여 선택한다면 `다음단계` 버튼이 활성화되어 `예매자 정보 입력 및 이용자 약관 동의` 단계로 넘어갈 수 있습니다. 또한 좌석의 선택 여부(Occupied State)는 `다음단계` 버튼을 클릭하여 `좌석 선택` 단계에서 넘어간 시점에 결정이 됩니다.

![좌석 중복 선택](https://media.oss.navercorp.com/user/21309/files/0aa8ac80-24e1-11eb-9495-f1c79dc8d821)

때문에 이용자가 `좌석 선택` 단계에 머무르는 동안 다른 이용자가 선택하여 예매된 좌석은 페이지를 새로고침 하지 않는 한 확인할 수 없다는 문제가 발생합니다. 좌석을 선택하는 도중 이런 식으로 누군가가 이미 예매한 좌석을 선택하더라도 `다음단계` 버튼을 누르기 전까진 알 수 없는 것입니다. 이러한 문제는 인기 가수의 콘서트 티켓팅과 같이 동시에 여러 인원이 한정된 좌석을 예매하기 위해 몰리는 상황에서 이용자가 선택하는 좌석이 이미 예매가 되어 몇 번이고 좌석 선택 단계를 반복하게 되는 불편함을 야기합니다.

## 1.3 제안 사항

이를 해결하기 위해 좌석 선택 여부를 실시간으로 반영하는 기능을 제안합니다. `좌석 선택` 단계에서 `다음단계` 버튼을 누르지 않더라도 이용자가 좌석을 선택한 순간 선택 여부가 반영되어 다른 이용자들도 해당 좌석이 예매 중임을 확인할 수 있도록 하여 좌석 선택 여부가 실시간으로 반영되지 않는 문제를 해결하겠습니다.

## 1.4 요구 사항

1. 기존 예매 서비스 구현
   - 기존에 제공하던 형태의 예매 서비스를 구현
   - 네이버 예약 플랫폼에서 다루는 여러 업종 중 좌석사용 상품을 취급하는 회차형 업종 만을 한정하여 제공
   - 예매 과정: 공연 선택 → 일정 선택 → 좌석 선택 → 결제 정보 입력 → 결제 → 예매 완료
2. 실시간 좌석 예약 기능
   - 이용자가 좌석을 클릭하자마자 다른 이용자에게 해당 좌석의 선택 여부를 알려줌
   - 이용자가 모두 `좌석 선택` 단계에 있더라도 선택된 좌석을 다른 이용자가 선택할 수 없음

</br>
</br>

# 2. 시스템 설계 명세

## 2.1 시스템 구조

![시스템 구조](https://media.oss.navercorp.com/user/21309/files/4fccde80-24e1-11eb-9b7e-1d75ac4fb153)

### Booking Service REST API

공연 제목, 포스터와 같은 기본 데이터 이용을 위한 API

### RealTime 좌석 서비스 GraphQL API

좌석 상태에 대한 실시간 정보 제공을 위한 API

사용자가 공연에 대한 정보 요청 시, **RealTime 좌석 서비스** 서버에서 Booking Service 서버로 공연 정보를 Request 후 MongoDB 내 저장된 좌석 상태 정보와 같이 사용자에게 Response

### 예약 정보 & 좌석 DB

좌석 상태에 대한 스토리지

### Booking Service

사용자 측 UX/UI로서 공연 좌석 정보를 Subscribe함으로써 지속적으로 좌석 상태 반영

## 2.2 프로세스
### 백엔드
![실시간 접속 프로세스](https://media.oss.navercorp.com/user/21309/files/62dfae80-24e1-11eb-892d-c87793bdfc12)

1. 유저 1이 좌석 선택 페이지 접속 시 좌석 State에 대한 Subscription과 Query
2. 유저 2와 3이 좌석 선택 페이지 접속 시 좌석 State에 대한 Subscription과 Query
3. 유저 1이 페이지 내 좌석 선택 Mutation
   1. 유저 1이 좌석 선택 시 해당 좌석에 대한 State Change 발생 (Free → Occupied)
   2. 좌석 State Change에 대한 Event Publish
   3. 유저 2와 유저 3의 페이지에서 State Change Event에 대한 업데이트
4. 유저 1이 선택한 좌석에 대한 결제 Mutation
   1. 해당 좌석에 대한 State Change 발생 (Occupied → Sold)
   2. 좌석 State Change에 대한 Event Publish
   3. 유저 2와 유저 3의 페이지에서 State Change Event에 대한 업데이트
5. 페이지 이동 및 종료 시 Subscription 종료

### 프론트엔드
1. 좌석 선택
![좌석 선택 프로세스](https://media.oss.navercorp.com/user/21308/files/9b43fd00-27ff-11eb-98ac-6c78e8bb20ba)

2. 좌석 갱신
![좌석 갱신 프로세스](https://media.oss.navercorp.com/user/21308/files/a6972880-27ff-11eb-9371-927d20a0c604)

</br>
</br>

# 3. 기술 스택

## 3.1 프론트엔드

ReactJS, GraphQL, Apollo-client, Material UI

## 3.2 백엔드

Node.js, GraphQL-yoga, MongoDB, Mongoose, Jest

## 3.3 Common

TypeScript, ESLint, Prettier

<br>
<br>

# 4. 업무

1. 기존 예매 시스템 구현 **(FE: 박정혁, BE: 김현우)**
    1. 현재 예매 가능한 공연 정보 리스트 조회 기능
    1. 특정 공연에 대한 정보 상세 조회 기능
    1. 공연에 대한 옵션 선택 기능
    1. 선택한 공연 결제 기능 (가상 시나리오)
2. 실시간 좌석 예약 기능 **(FE: 박정혁, BE: 박정혁, 김현우)**
    1. 실시간 좌석 상태 반영 API **(박정혁)**
    1. 실시간 좌석 상태 관리 **(김현우)**
3. Canvas를 이용한 좌석표 구현 **(FE: 김현우)**
    1. Canvas와 svg를 이용한 좌석 상태 표현 기능

<br>
<br>